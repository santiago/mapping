// @ypocat 2012, bsd lic
(function(){function b(b){function d(){for(var a="",b=0,c=Math.floor,d=Math.random,e=String.fromCharCode;b<8;b++)a+=e(c(d()*26)+(c(d()*2)?97:65));return a}var c=function(b,c,d,f){this.url=b,this.protocols=c,this.connTimeout=d||4e3,this.listeners={},this.reconnDelay=f||1e3,this.on("message",function(b){try{try{var c=JSON.parse(b.data)}catch(b){throw new Error("invalid data received")}if(c.r){var d=(this.__c||{})[c.r];if(!d)throw new Error("missing callback[4]:"+c.r);delete this.__c[c.r],d.apply(null,c.a);return}if(c.c){var e=this;c.a.push(function(){var d={r:c.c,a:Array.prototype.slice.call(arguments)};if(d.a.length&&(b=a=d.a[0])instanceof Error){d.a[0]={message:b.message,stack:b.stack};for(var f in b)a[f]=b[f]}e.socket.send(JSON.stringify(d))})}this.emit.apply(this,c.a)}catch(b){this.emit("error",b)}}),this.on("open",function(){this.__clearConnectTimeout()}),this.on("close",function(){for(var a=Object.keys(this.__c||{}),b=0;b<a.length;b++)(function(a){(typeof process!="undefined"?process.nextTick:setTimeout)(function(){a(new Error("disconnected"))},0)})(this.__c[a[b]]);this.__c=null;if(this.socket){for(var b=0;b<e.length;b++)this.socket["on"+e[b]]=null;this.socket=null}this.__clearConnectTimeout();if(this.connTimeout!==-1){var c=this;setTimeout(function(){this.connTimeout!==-1&&c.connect()},c.reconnDelay)}}),this.on("error",function(a){typeof module!="undefined"&&a.message&&a.message.indexOf("ECONNREFUSED")!=-1&&this.emit("close")}),this.connect()};c.prototype.connect=function(){var a=this;if(this.socket){if(this.connTimeout!==-1)return this.disconnect();this.disconnect()}this.connTimeout!==-1&&(this.connTimer=setTimeout(function(){a.socket.readyState!==b.OPEN&&(a.__clearConnectTimeout(),a.disconnect())},this.connTimeout)),this.socket=new b(this.url,this.protocols);for(var c=0;c<e.length;c++)this.socket["on"+e[c]]=function(b){return function(){a.__dispatch(b,arguments)}}(e[c])},c.prototype.disconnect=function(a){if(!this.socket)return;a&&(this.connTimeout=-1);try{this.socket.close()}catch(b){this.emit("error",b)}},c.prototype.message=function(){var a=arguments.length-1,b={};if(typeof arguments[a]=="function"){this.__c||(this.__c={});do b.c=d();while(this.__c[b.c]);this.__c[b.c]=arguments[a--]}b.a=Array.prototype.slice.call(arguments,0,a+1),this.socket.send(JSON.stringify(b))},c.prototype.on=function(a,b){this.listeners[a]=this.listeners[a]||[],this.listeners[a].push(b)},c.prototype.removeListener=function(a,b){if(a in this.listeners==0)return;this.listeners[a].splice(this.listeners[a].indexOf(fct),1)},c.prototype.emit=function(a){if(a in this.listeners==0)return;for(var b=0,c=this.listeners[a],d=c.length;b<d;b++)c[b].apply(this,Array.prototype.slice.call(arguments,1))},c.prototype.__clearConnectTimeout=function(){this.connTimer&&(clearTimeout(this.connTimer),delete this.connTimer)},c.prototype.__dispatch=function(a,b){var c=Array.prototype.slice.call(b);c.unshift(a),this.emit.apply(this,c)};var e=["open","error","close","message"];return c}typeof module!="undefined"?module.exports=b:window.InitWebSocketRPC=b})();