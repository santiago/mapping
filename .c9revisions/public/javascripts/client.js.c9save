{"ts":1348847316044,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"function init(opts) {\n    var self= this;\n    \n    // Render Geo UI\n    startUi.call(this);\n\n    // The marker icon\n    var size = new OpenLayers.Size(15,24);\n    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);\n    // var icon = new OpenLayers.Icon('/javascripts/thirdparty/img/marker-gold.png', size, offset);\n    var icon = new OpenLayers.Icon('/images/marker-3.png', size, offset);\n\n    this.nodes= {};\n\n    this.map = new OpenLayers.Map('map');\n    var map= this.map;\n    map.addControl(new OpenLayers.Control.LayerSwitcher());\n\n    this._marking= false;\n\n    var markers = new OpenLayers.Layer.Markers(\"Markers\");\n    map.addLayer(markers);\n\n    $(\"#map\").on('mousedown', function(e) {\n        var point= map.getLonLatFromViewPortPx({x:e.offsetX,y:e.offsetY});\n        point.transform(\n            map.getProjectionObject(),\n            new OpenLayers.Projection(\"EPSG:4326\"));\n        lastMouseDown= [point.lat,point.lon];\n    });\n    \n    $(\"#map\").on('mousedown', function(e) {\n    });\n\n    $(\"#map\").on('mouseup', function(e) {\n\t// Remove the annoying Google copyright popup\n\t$(\".olLayerGooglePoweredBy.olLayerGoogleV3\").hide();\n    });\n\n    map.events.register('move', this, function(e) {\n\tthis._moved= true;\n    });\n\n    var mousemove= function(e) {\n        var point= map.getLonLatFromViewPortPx(e.xy);\n\tmarkers.addMarker(new OpenLayers.Marker(point,icon));\n    }\n    // map.events.register('mousemove', this, mousemove);\n\n    map.events.register('click', this, function(e) {\n        var point= map.getLonLatFromViewPortPx(e.xy);\n\n\tif(this._marking) {\n\t    map.events.unregister('mousemove', this, mousemove);\n\t    markers.addMarker(new OpenLayers.Marker(point,icon));\n\t    this._marking= false;\n\t    this._moved= false;\n\n\t    $(\"#formbox input[name=latitude]\").val(point.lat);\n\t    $(\"#formbox input[name=longitude]\").val(point.lon);\n\t    $(\"#formbox .button\").show();\n\t    $(\"#formcontent .move-banner\").hide();\n\t}\n    });\n\n    var gphy = new OpenLayers.Layer.Google(\n        \"Google Physical\",\n        {type: google.maps.MapTypeId.TERRAIN}\n    );\n    \n    var gmap = new OpenLayers.Layer.Google(\n        \"Google Streets\", // the default\n        {numZoomLevels: 20}\n    );\n    var ghyb = new OpenLayers.Layer.Google(\n        \"Google Hybrid\",\n        {type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}\n    );\n    var gsat = new OpenLayers.Layer.Google(\n        \"Google Satellite\",\n        {type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22}\n    );\n\n    var osm = new OpenLayers.Layer.OSM();\n    \n    map.addLayers([osm, gmap, gphy, ghyb, gsat]);\n\n    // Google.v3 uses EPSG:900913 as projection, so we have to\n    // transform our coordinates\n    map.setCenter(new OpenLayers.LonLat(10.2, 48.9).transform(\n        new OpenLayers.Projection(\"EPSG:4326\"),\n        map.getProjectionObject()\n    ), 5);\n\n    map.addControl(new OpenLayers.Control.MousePosition());\n\n    $(\"#formbox .button.mapme\").click(function() {\n\tvar data= RegisterForm.getValidData({ exclude: ['latitude','longitude'] });\n\tif(data) {\n\t    map.events.register('mousemove', self, mousemove);\n\t    self._marking= true;\n\t    $(\"#formbox .button\").hide();\n\t    $(\"#formcontent .move-banner\").show();\n\t}\n    });\n\n    $(\"#formbox .button.addme\").click(function() {\n\tvar data= RegisterForm.getValidData();\n\tif(data) {\n\t    $.post('/registro', data, function(a, b, c) {\n\t\tlocation.href= '/';\n\t    });\n\t}\n    });\n\n    $(\".node-card .button\").live('click', function() {\n\t$(\".rslide-card.node-front\").animate({\"right\": \"-450\"})\n\t$(\".rslide-card.node-list\").animate({\"right\": \"0\"})\n    });\n\n    // Get whatever's there\n    this.showLabels = function() {\n\t$.get('/proyectos.json', function(data) {\n\t    data.forEach(function(node) {\n\t\tself.nodes[node._id]= node;\n\n\t\tvar point= new OpenLayers.LonLat(node.longitude, node.latitude);\n\t\tvar marker= new OpenLayers.Marker(point,icon.clone());\n\t\tmarkers.addMarker(marker);\n\t    \n\t\t// Position label\n\t\tvar popupPoint= new OpenLayers.LonLat(node.longitude+10, node.latitude+40);\n\t\tself.popup(popupPoint, node._id, node.name);\n\n\t\t// Style label\n\t\tvar $nodeLabel= $(\"#\"+node._id);\n\t\t$nodeLabel.addClass(\"maplabel\");\n\t\t$nodeLabel.css({\n\t\t    border: \"2px solid #666\"\n\t\t});\n\t\t$nodeLabel.find('#'+node._id+'_close').remove();\n\n\t\t// on mouse over label\n\t\t$nodeLabel.on('mouseover', function(e) {\n\t\t    $nodeLabel.addClass('hover');\n\t\t    $nodeLabel.css({\n\t\t\tborder: \"2px solid blue\"\n\t\t    });\n\t\t});\n\n\t\t// on mouse out label\n\t\t$nodeLabel.on('mouseout', function(e) {\n\t\t    $nodeLabel.removeClass('hover');\n\t\t    $nodeLabel.css({\n\t\t\tborder: \"2px solid #666\"\n\t\t    });\n\t\t});\n\n\t\t// on click label\n\t\t$nodeLabel.on('click', function(e) {\n\t\t    var id= $(this).attr('id');\n\t\t    var node= self.nodes[id];\n\t\t    RegisterForm.populate(node);\n\t\t    $(\".rslide-card.node-front\").animate({\"right\": \"0\"})\n\t\t});\n\t    });\n\t});\n    };\n}\n\ninit.prototype.popup= function(lonlat, id, text) {\n    var popup= new OpenLayers.Popup(id, // Label\n\t\t    lonlat, // Point\n                    new OpenLayers.Size(text.length*8,15), // Size\n                    text, // Text\n                    true); // ?\n    this.map.addPopup(popup);\n};\n\nvar FormValidator= function(fields) {\n    this.fields= fields;\n    this.valid= false;\n};\n\nFormValidator.prototype.populate= function(obj) {\n    var url;\n    for(var f in this.fields) {\n\tvar url= f == 'url'  ? \"http://\"+obj[f] : undefined;\n\turl= f == 'twitter'  ? \"http://twitter.com/\"+obj[f] : url;\n\turl= f == 'facebook' ? \"http://facebook.com/\"+obj[f] : url;\n\n\tswitch(f) {\n\tcase 'name':\n\t    $(\"#node-front\").find(\"h2\").text(obj[f]);\n\t    break;\t    \n\tcase 'description':\n\t    $(\"#node-front\").find(\".element.\"+f+\" p\").text(obj[f]);\n\t    break;\t    \n\tcase 'url':\n\tcase 'facebook':\n\tcase 'twitter':\n\t    $(\"#node-front\").find(\".element.\"+f+\" a\")\n\t\t.text(obj[f])\n\t\t.attr('href', url)\n\t    break;\n\t}\n    }\n};\n\nFormValidator.prototype.validate= function(opts) {\n    var exclude= opts.exclude||[];\n    var validators= {\n\t'presence': function(val) {\n\t    if(val == '' || !val) {\n\t\treturn false\n\t    }\n\t    return true\n\t}\n    };\n\n    $(\"#formbox\").find(\".error\").remove();\n    var fields= this.fields;\n    for(var f in fields) {\n\tvar val= $(\"#formbox\").find(fields[f].find).val();\n\tif(fields[f].validate && fields[f].validate.length) {\n\t    for(var i in fields[f].validate) {\n\t\tif(exclude.indexOf(f) > -1) {\n\t\t    break;\n\t\t}\n\t\tvar test= fields[f].validate[i];\n\t\tif(!validators[test](val)) {\n\t\t    $(\"#formbox\").find(fields[f].find)\n\t\t\t.before(\"<p class='error'>* campo obligatorio</p>\");\n\t\t    return false;\n\t\t}\n\t    }\n\t}\n\tfields[f].data= val;\n    }\n    return true;\n}\n\nFormValidator.prototype.getValidData= function(opts) {\n    var data;\n    opts= opts||{};\n    if(this.validate(opts)) {\n\tdata= {};\n\tfor(var f in this.fields) {\n\t    data[f]= this.fields[f].data;\n\t}\n    }\n    return data;\n};\n\nvar RegisterForm= new FormValidator(\n    {\n\t'name': {\n\t    'find': 'input[name=name]',\n\t    'validate': ['presence']\n\t},\n\t'email': {\n\t    'find': 'input[name=email]',\n\t    'validate': ['presence']\n\t},\n\t'description': {\n\t    'find': 'textarea[name=descripcion]',\n\t    'validate': ['presence']\n\t},\n\t'url': {\n\t    'find': 'input[name=url]',\n\t    'validate': ['presence']\n\t},\n\t'latitude': {\n\t    'find': 'input[name=latitude]',\n\t    'validate': ['presence']\n\t},\n\t'longitude': {\n\t    'find': 'input[name=longitude]',\n\t    'validate': ['presence']\n\t},\n\t'twitter': {\n\t    'find': 'input[name=twitter]',\n\t},\n\t'facebook': {\n\t    'find': 'input[name=fb]',\n\t},\n\t'tags': {\n\t    'find': 'input[name=tags]',\n\t    'validate': ['presence']\n\t},\n\t'members': {\n\t    'find': 'input[name=miembros]'\n\t}\n    });\n\n// init private methods\nfunction startUi() {\n    var self= this;\n    \n    $(\".start\").hide();\n    $(\"#main\").show();\n    $(\"header .user\").text(this.userId);\n    \n    $(\"#actions .action\").click(function(e) {\n        e.preventDefault();\n        $(this).blur();\n\n\t$(\"#actions .action.on\").removeClass('on');\n\t$(this).addClass('on');\n\n        if($(this).hasClass('registro')) { \n\t    $(\".active.rslide-card\").animate({ right: '-450px' });\n\n\t    $(\".login.rslide-card\").animate({ right: '0px' }, function() {\n\t\t$(\".active.rslide-card\").removeClass('active');\n\t\t$(\".login.rslide-card\").addClass('active');\n\t    });\n\t}\n\n        if($(this).hasClass('search')) { \n\t    $(\".active.rslide-card\").animate({ right: '-450px' });\n\n\t    $(\".node-list.rslide-card\").animate({ right: '0px' }, function() {\n\t\t$(\".active.rslide-card\").removeClass('active');\n\t\t$(\".node-list.rslide-card\").addClass('active');\n\t    });\n\t}\n\n        if($(this).hasClass('salir')) { \n\t    location.href= '/logout'\n\t}\n    });\n\n    $(\"#node-list .node-item\").on('mouseover', function(e) {\n\tvar id= $(this).attr('id').split('-')[2];\n\t$(this).addClass('hover');\n\n\t// Click on social icons\n\t$(\"#node-list .social-icons a\").hide();\n\n\t(function(cx) {\n\t    var sites= ['facebook', 'twitter', 'youtube', 'vimeo'];\n\t    for(var _s in sites) {\n\t\tvar s= sites[_s];\n\t\tif(self.nodes[id][s]) {\n\t\t    var $a= $(cx).find('.'+s).closest('a');\n\t\t    var url= s == 'facebook' ? self.nodes[id][s] : undefined;\n\t\t    if(url && !url.match(/facebook.com/)) {\n\t\t\turl= 'http://facebook.com/'+url;\n\t\t    }\n\t\t    if(url && !url.match(/^http:/)) {\n\t\t\turl= 'http://'+url;\n\t\t    }\n\n\t\t    url= s == 'twitter' ? 'http://twitter.com/'+self.nodes[id][s] : url;\n\t\t    $a.attr('href', url);\n\t\t    $a.show();\n\t\t}\n\t    }\n\t})(this);\n\n\tsetTimeout(function() {\n\t    var h= $(\"#node-\"+id+\" .desc\").height();\n\t    $(\"#node-\"+id+\" .info\")\n\t    $(\"#node-\"+id+\" .info\").animate({ height: 40+h });\n\t}, 200);\n\t\n\t$(this).append(\n\t    $(\"#node-list .social-icons\").show()\n\t);\n    }); // mouseover\n\n    $(\"#node-list .node-item\").on('mouseout', function(e) {\n\t$(this).removeClass('hover');\n    });\n\n    // Click on .name at node-item\n    $(\"#node-list .node-item .name a\").on('click', function(e) {\n\te.preventDefault();\n\t$(this).blur();\n\tvar id= $(this).closest('.node-item').attr('id').split('-')[2];\n\t$.get('/data/node/'+id+'.html', function(data) {\n\t    $(\".rslide-card.node-list\").animate({\"right\": \"-450\"})\n\t    $(\".rslide-card.node-front\").html(data);\n\t    $(\"#node-\"+id).show();\n\t    var lonlat= [self.nodes[id].longitude, self.nodes[id].latitude];\n\t    var point= new OpenLayers.LonLat(lonlat[0], lonlat[1])\n\t    self.map.panTo(point);\n\n\t    $(\".rslide-card.node-front\").animate({\"right\": \"0\"}, function() {\n\t\t$(\".rslide-card.active\").removeClass(\"active\");\n\t\t$(\".rslide-card.node-front\").addClass(\"active\");\n\t    })\n\t});\n    });\n}\n\n// Start the App\njQuery(document).ready(function($) {\n    function success(pos) {\n\tvar position= [pos.coords.latitude,pos.coords.longitude];\n\tvar point= new OpenLayers.LonLat(position[1],position[0])\n            .transform(new OpenLayers.Projection(\"EPSG:4326\"),app.map.getProjectionObject());\n\tapp.map.setCenter(point, 16);\n\tapp.showLabels();\n    }\n\n    function error() {\n    }\n\n    var userId= sessionStorage.getItem(\"userId\");\n    var app= new init();\n\n    if (navigator.geolocation) {\n        navigator.geolocation.getCurrentPosition(success, error);\n    } else {\n        alert('Geolocation not supported');\n        return;\n    }\n});"]],"start1":0,"start2":0,"length1":0,"length2":11100}]],"length":11100}
{"contributors":[],"silentsave":false,"ts":1348869878673,"patch":[[{"diffs":[[-1,"function init(opts) {\n    var self= this;\n    \n    // Render Geo UI\n    startUi.call(this);"],[1,"var Map = new (function _Map() {"],[0,"\n\n  "]],"start1":0,"start2":0,"length1":95,"length2":36},{"diffs":[[0,"(markers);\n\n"],[1,"})();\n\n\nfunction init(opts) {\n    var self= this;\n    \n    // Render Geo UI\n    startUi.call(this);\n\n    // The marker icon\n    var size = new OpenLayers.Size(15,24);\n    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);\n    // var icon = new OpenLayers.Icon('/javascripts/thirdparty/img/marker-gold.png', size, offset);\n    var icon = new OpenLayers.Icon('/images/marker-3.png', size, offset);\n\n\n"],[0,"    $(\"#map\""]],"start1":585,"start2":585,"length1":24,"length2":428}]],"length":11445,"saved":false}
